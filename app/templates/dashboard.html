{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Stat Card 1 -->
    <div class="glass p-6 rounded-2xl relative overflow-hidden group">
        <div
            class="absolute right-0 top-0 h-24 w-24 bg-primary/10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
        </div>
        <div class="flex items-center justify-between relative z-10">
            <div>
                <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Total Patients</p>
                <h3 id="stat-patients" class="text-3xl font-display font-bold text-slate-800 mt-1">{{ patient_count }}
                </h3>
            </div>
            <div class="h-12 w-12 rounded-xl bg-primary/20 text-primary flex items-center justify-center text-xl">
                <i class="fa-solid fa-users"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
            <span class="text-green-500 flex items-center"><i class="fa-solid fa-arrow-trend-up mr-1"></i> +12%</span>
            <span class="text-slate-500 ml-2">from last month</span>
        </div>
    </div>

    <!-- Stat Card 2 -->
    <div class="glass p-6 rounded-2xl relative overflow-hidden group">
        <div
            class="absolute right-0 top-0 h-24 w-24 bg-secondary/10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
        </div>
        <div class="flex items-center justify-between relative z-10">
            <div>
                <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Appointments</p>
                <h3 id="stat-appointments" class="text-3xl font-display font-bold text-slate-800 mt-1">{{
                    appointment_count }}</h3>
            </div>
            <div class="h-12 w-12 rounded-xl bg-secondary/20 text-secondary flex items-center justify-center text-xl">
                <i class="fa-regular fa-calendar-check"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
            <span class="text-green-500 flex items-center"><i class="fa-solid fa-arrow-trend-up mr-1"></i> +5%</span>
            <span class="text-slate-500 ml-2">from yesterday</span>
        </div>
    </div>

    <!-- Stat Card 3 -->
    <div class="glass p-6 rounded-2xl relative overflow-hidden group">
        <div
            class="absolute right-0 top-0 h-24 w-24 bg-accent/10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
        </div>
        <div class="flex items-center justify-between relative z-10">
            <div>
                <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Doctors Available</p>
                <h3 id="stat-doctors" class="text-3xl font-display font-bold text-slate-800 mt-1">{{ doctor_count }}
                </h3>
            </div>
            <div class="h-12 w-12 rounded-xl bg-accent/20 text-accent flex items-center justify-center text-xl">
                <i class="fa-solid fa-user-doctor"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
            <span class="text-slate-500">Active now</span>
        </div>
    </div>

    <!-- Stat Card 4 -->
    <div class="glass p-6 rounded-2xl relative overflow-hidden group">
        <div
            class="absolute right-0 top-0 h-24 w-24 bg-orange-500/10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
        </div>
        <div class="flex items-center justify-between relative z-10">
            <div>
                <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Revenue</p>
                <h3 class="text-3xl font-display font-bold text-slate-800 mt-1">$<span id="stat-revenue">{{ revenue
                        }}</span></h3>
            </div>
            <div class="h-12 w-12 rounded-xl bg-orange-500/20 text-orange-500 flex items-center justify-center text-xl">
                <i class="fa-solid fa-file-invoice-dollar"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
            <span class="text-green-500 flex items-center"><i class="fa-solid fa-arrow-trend-up mr-1"></i> +24%</span>
            <span class="text-slate-500 ml-2">daily average</span>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Chart Section -->
    <div class="lg:col-span-2 glass p-6 rounded-2xl border border-slate-200">
        <h4 class="text-lg font-bold text-slate-800 mb-4">Appointments Overview (Last 7 Days)</h4>
        <div class="relative h-72 w-full">
            <canvas id="activityChart"></canvas>
        </div>
    </div>

    <!-- Recent Activity / Upcoming Appointments -->
    <div class="glass p-6 rounded-2xl border border-slate-200">
        <h4 class="text-lg font-bold text-slate-800 mb-4">Upcoming Schedule</h4>
        <div class="space-y-4">
            {% for apt in upcoming_appointments %}
            <div
                class="flex items-center p-3 rounded-xl bg-white hover:bg-slate-50 shadow-sm border border-slate-100 transition-colors cursor-pointer">
                <div
                    class="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold">
                    {{ apt.doctor.user.username[0] | upper }}
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-slate-800">{{ apt.reason }}</p>
                    <p class="text-xs text-slate-500">Dr. {{ apt.doctor.user.username }}</p>
                </div>
                <div class="text-xs text-slate-500">{{ apt.date_time.strftime('%I:%M %p') }}</div>
            </div>
            {% else %}
            <p class="text-slate-500 text-sm">No upcoming appointments.</p>
            {% endfor %}
        </div>
        <a href="{{ url_for('appointment.list_appointments') }}"
            class="block text-center w-full mt-6 py-2 rounded-lg border border-slate-300 text-sm text-slate-600 hover:bg-slate-100 transition-colors">View
            All Schedule</a>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Real-Time Polling (Same as before)
    function updateStats() {
        fetch('/api/dashboard/stats')
            .then(response => response.json())
            .then(data => {
                animateValue("stat-patients", parseInt(document.getElementById("stat-patients").innerText.replace(/,/g, '')), data.patients, 1000);
                animateValue("stat-appointments", parseInt(document.getElementById("stat-appointments").innerText.replace(/,/g, '')), data.appointments, 1000);
                animateValue("stat-doctors", parseInt(document.getElementById("stat-doctors").innerText.replace(/,/g, '')), data.doctors, 1000);
                animateValue("stat-revenue", parseInt(document.getElementById("stat-revenue").innerText.replace(/,/g, '')), data.revenue, 1000);
            })
            .catch(error => console.error('Error fetching stats:', error));
    }

    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const obj = document.getElementById(id);
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end;
            }
        };
        window.requestAnimationFrame(step);
    }

    setInterval(updateStats, 5000);


    const ctx = document.getElementById('activityChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(14, 165, 233, 0.5)'); // Sky blue
    gradient.addColorStop(1, 'rgba(14, 165, 233, 0.05)');

    const labels = {{ chart_labels | tojson }};
    const data = {{ chart_data | tojson }};

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Appointments',
                data: data,
                borderColor: '#0ea5e9', // Primary color
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#0ea5e9',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: { color: '#64748b', stepSize: 1 }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#64748b' }
                }
            }
        }
    });
</script>
{% endblock %}